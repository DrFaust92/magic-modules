resource "google_bigquery_connection" "<%= ctx[:primary_resource_id] %>" {
   connection_id = "<%= ctx[:vars]['connection_id'] %>"
   location      = "aws-us-east-1"
   friendly_name = "ðŸ‘‹"
   description   = "a riveting description"
   kms_key_name  = "<%= ctx[:vars]['kms_key_name'] %>"
   aws { 
      access_role {
         iam_role_id =  "<%= ctx[:vars]['iam_role_id'] %>"
      }
   }

  depends_on = [
    google_kms_crypto_key_iam_member.crypto_key
  ]
}

resource "google_kms_crypto_key_iam_member" "crypto_key" {
   crypto_key_id = "<%= ctx[:vars]['kms_key_name'] %>"
   role          = "roles/cloudkms.cryptoKeyEncrypterDecrypter"
   member        = "serviceAccount:service-${data.google_project.project.number}@gcp-sa-artifactregistry.iam.gserviceaccount.com"
 }
 
 data "google_project" "project" {}